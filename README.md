# 课题组服务器使用登记系统

一个基于Python Flask的Web应用程序，用于管理课题组内9755和5520+两台服务器的使用登记和资源监控。

## 系统概述

本系统专为课题组设计，提供了直观的Web界面来管理服务器资源使用情况。系统支持两台服务器：
- **9755服务器**：3个节点，2张GPU
- **5520+服务器**：56个核心，1张GPU

## 主要功能

### 🖥️ 资源监控
- 实时显示服务器资源使用情况
- 自动计算剩余可用资源
- 直观的进度条显示资源占用比例
- 30秒自动刷新资源状态

### 📝 使用登记
- 支持两台服务器的独立登记
- 详细的使用信息记录
- 任务状态跟踪（进行中/已完成）
- 用户友好的表单界面

### 💾 数据管理
- 所有数据自动同步到Excel文件
- 自动备份机制，每次修改前创建备份
- 备份文件按时间戳命名，永久保存
- 支持Excel格式的数据导出

### 🔄 智能计算
- 只统计未完成任务的资源占用
- 自动解析节点/核数配置
- 实时更新剩余资源显示

## 项目结构

```
table/
├── app.py                 # Flask主应用程序
├── requirements.txt       # 依赖包列表
├── README.md             # 项目文档
├── templates/            # HTML模板文件
│   ├── base.html         # 基础模板
│   ├── index.html        # 资源概览页面
│   ├── 9755.html         # 9755服务器页面
│   └── 5520.html         # 5520+服务器页面
├── static/               # 静态文件目录
│   ├── css/              # CSS样式文件
│   └── js/               # JavaScript文件
├── backups/              # 自动备份目录
├── 9755_records.xlsx     # 9755服务器记录文件
└── 5520_records.xlsx     # 5520+服务器记录文件
```

## 安装和配置

### 环境要求
- Python 3.9+
- Conda (推荐)

### 1. 创建Conda环境
```bash
conda create -n server_system python=3.9 -y
```

### 2. 激活环境
```bash
source /home/patrick/anaconda3/etc/profile.d/conda.sh
conda activate server_system
```

### 3. 安装依赖
```bash
pip install -r requirements.txt
```

### 4. 启动应用
```bash
python app.py
```

系统将在以下地址启动：
- 本地访问：http://127.0.0.1:5000
- 局域网访问：http://192.168.1.133:5000

## 使用说明

### 资源概览页面
- 访问首页可查看两台服务器的资源使用概况
- 进度条显示当前资源占用比例
- 显示剩余可用资源数量
- 点击"查看详情"进入具体服务器管理页面

### 9755服务器登记
登记字段说明：
- **时间**：登记日期（格式：2025.6.6）
- **姓名**：使用者姓名
- **占用节点**：使用的节点编号（如：2,3 或 1）
- **占用GPU**：是否使用GPU（是/否）
- **是否使用远程桌面**：是否需要图形界面（是/否）
- **任务类型**：计算任务类型（如：vasp、gaussian等）
- **预计使用时间**：使用时间段（格式：2025.6.6~2025.6.7）
- **是否完成**：任务状态（未完成时不填，完成时选择"已完成"）

### 5520+服务器登记
登记字段说明：
- **时间**：登记日期（格式：2025.6.7）
- **姓名**：使用者姓名
- **使用核数**：使用的核心数（输入"all"表示全部56核，或具体数字）
- **占用GPU**：是否使用GPU（是/否）
- **是否使用远程桌面**：是否需要图形界面（是/否）
- **任务类型**：计算任务类型（如：matlab、python等）
- **预计使用时间**：使用时间段（格式：2025.6.7~2025.6.10）
- **是否完成**：任务状态（未完成时不填，完成时选择"已完成"）

## 数据存储和备份

### Excel文件格式
系统自动维护两个Excel文件：
- `9755_records.xlsx`：9755服务器使用记录
- `5520_records.xlsx`：5520+服务器使用记录

### 自动备份
- 每次数据修改前自动创建备份
- 备份文件存储在`backups/`目录
- 备份文件命名格式：`原文件名_YYYYMMDD_HHMMSS.xlsx`
- 所有备份文件永久保存，不会被覆盖

### 数据同步
- 网页上的所有修改立即同步到Excel文件
- 支持实时数据更新
- 确保数据的一致性和完整性

## 资源计算逻辑

### 9755服务器
- **总资源**：3个节点，2张GPU
- **占用计算**：
  - 节点：解析"占用节点"字段，支持逗号分隔的多节点
  - GPU：根据"占用GPU"字段统计
- **剩余资源**：总资源 - 未完成任务占用资源

### 5520+服务器
- **总资源**：56个核心，1张GPU
- **占用计算**：
  - 核数：支持"all"（全部56核）或具体数字
  - GPU：根据"占用GPU"字段统计
- **剩余资源**：总资源 - 未完成任务占用资源

### 重要说明
- 只统计"是否完成"字段为空或非"Yes"的记录
- 已完成的任务不计入资源占用
- 资源使用情况每30秒自动更新

## API接口

### GET /api/resources
返回当前资源使用情况的JSON数据

响应格式：
```json
{
  "9755": {
    "nodes_remaining": 1,
    "nodes_total": 3,
    "nodes_used": 2,
    "gpu_remaining": 1,
    "gpu_total": 2,
    "gpu_used": 1
  },
  "5520": {
    "cores_remaining": 20,
    "cores_total": 56,
    "cores_used": 36,
    "gpu_remaining": 0,
    "gpu_total": 1,
    "gpu_used": 1
  }
}
```

## 技术栈

- **后端**：Python Flask 2.3.3
- **数据处理**：Pandas 2.3.0
- **Excel操作**：OpenPyXL 3.1.2
- **前端**：Bootstrap 5.1.3
- **模板引擎**：Jinja2

## 系统特性

### 用户体验
- 响应式设计，支持多种设备
- 直观的进度条显示
- 实时数据更新
- 表单自动填充当前日期

### 数据安全
- 自动备份机制
- 文件时间戳保护
- 数据完整性验证

### 系统稳定性
- 错误处理机制
- 数据类型验证
- 资源计算容错

## 故障排除

### 常见问题

1. **Pandas兼容性错误**
   ```bash
   pip install --upgrade pandas numpy
   ```

2. **Conda环境激活问题**
   ```bash
   source /home/patrick/anaconda3/etc/profile.d/conda.sh
   conda activate server_system
   ```

3. **端口占用问题**
   - 修改`app.py`中的端口号
   - 或终止占用端口的进程

4. **Excel文件权限问题**
   - 确保目录有写权限
   - 检查文件是否被其他程序占用

### 日志查看
系统使用Flask内置日志，启动时会显示：
- 服务器地址和端口
- 调试模式状态
- 错误信息（如有）

## 开发和扩展

### 添加新服务器
1. 在`ServerManager`类中添加新的Excel文件处理方法
2. 创建对应的HTML模板
3. 添加路由处理函数
4. 更新资源计算逻辑

### 自定义字段
1. 修改Excel初始化列名
2. 更新HTML表单
3. 调整数据处理逻辑

### 部署到生产环境
推荐使用WSGI服务器如Gunicorn：
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

## 版本信息

- **版本**：1.0.0
- **开发时间**：2025年6月
- **Python版本**：3.9+
- **Flask版本**：2.3.3

## 许可证

本项目仅供课题组内部使用。

## 联系方式

如有问题或建议，请联系课题组管理员。

---

*本文档最后更新：2025年6月11日*